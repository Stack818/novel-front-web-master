{"ast":null,"code":"import \"@/assets/styles/book.css\";\nimport man from \"@/assets/images/man.png\";\nimport { reactive, toRefs, onMounted, onUpdated } from \"vue\";\nimport { ElMessage } from \"element-plus\";\nimport { useRouter, useRoute } from \"vue-router\";\nimport { getBookById, addVisitCount, getLastChapterAbout, listRecBooks, listNewestComments } from \"@/api/book\";\nimport { comment, deleteComment, updateComment } from \"@/api/user\";\nimport { getUid } from \"@/utils/auth\";\nimport Header from \"@/components/common/Header\";\nimport Footer from \"@/components/common/Footer\";\nimport author_head from \"@/assets/images/author_head.png\";\nimport no_comment from \"@/assets/images/no_comment.png\";\nimport { goToAnchor } from \"@/utils\";\nexport default {\n  name: \"book\",\n  components: {\n    Header,\n    Footer\n  },\n  setup() {\n    const route = useRoute();\n    const router = useRouter();\n    const state = reactive({\n      uid: getUid(),\n      book: {},\n      books: [],\n      chapterAbout: {},\n      commentContent: \"\",\n      newestComments: {},\n      imgBaseUrl: process.env.VUE_APP_BASE_IMG_URL,\n      dialogUpdateCommentFormVisible: false,\n      commentId: \"\",\n      updateComment: \"\"\n    });\n    onMounted(() => {\n      const bookId = route.params.id;\n      loadBook(bookId);\n      loadRecBooks(bookId);\n      loadLastChapterAbout(bookId);\n      loadNewestComments(bookId);\n    });\n    onUpdated(() => {\n      console.log(\"onUpdated==========================\");\n      for (let i = 0; i < state.books.length; i++) {\n        document.getElementById(\"bookCover\" + i).setAttribute(\"onerror\", \"this.src='default.gif';this.onerror=null\");\n      }\n    });\n    const loadBook = async bookId => {\n      const {\n        data\n      } = await getBookById(bookId);\n      state.book = data;\n      document.getElementById(\"bookCover\").setAttribute(\"onerror\", \"this.src='default.gif';this.onerror=null\");\n      addBookVisit(bookId);\n    };\n    const loadRecBooks = async bookId => {\n      const {\n        data\n      } = await listRecBooks({\n        bookId: bookId\n      });\n      state.books = data;\n    };\n    const loadLastChapterAbout = async bookId => {\n      const {\n        data\n      } = await getLastChapterAbout({\n        bookId: bookId\n      });\n      state.chapterAbout = data;\n    };\n    const bookContent = (bookId, chapterId) => {\n      router.push({\n        path: `/book/${bookId}/${chapterId}`\n      });\n    };\n    const bookDetail = bookId => {\n      router.push({\n        path: `/book/${bookId}`\n      });\n      loadBook(bookId);\n      loadRecBooks(bookId);\n      loadLastChapterAbout(bookId);\n      loadNewestComments(bookId);\n    };\n    const chapterList = bookId => {\n      router.push({\n        path: `/chapter_list/${bookId}`\n      });\n    };\n    const addBookVisit = async bookId => {\n      addVisitCount({\n        bookId: bookId\n      });\n    };\n    const loadNewestComments = async bookId => {\n      const {\n        data\n      } = await listNewestComments({\n        bookId: bookId\n      });\n      state.newestComments = data;\n    };\n    const userComment = async () => {\n      if (!state.commentContent) {\n        ElMessage.error(\"用户评论不能为空！\");\n        return;\n      }\n      if (state.commentContent.length < 10) {\n        ElMessage.error(\"评论不能少于 10 个字符！\");\n        return;\n      }\n      if (state.commentContent.length > 512) {\n        ElMessage.error(\"评论不能多于 512 个字符！\");\n        return;\n      }\n      await comment({\n        bookId: state.book.id,\n        commentContent: state.commentContent\n      });\n      state.commentContent = \"\";\n      loadNewestComments(state.book.id);\n    };\n    const updateUserComment = async (id, comment) => {\n      state.dialogUpdateCommentFormVisible = true;\n      state.updateComment = comment;\n      state.commentId = id;\n    };\n    const deleteUserComment = async id => {\n      await deleteComment(id);\n      loadNewestComments(state.book.id);\n    };\n    const goUpdateComment = async id => {\n      state.dialogUpdateCommentFormVisible = false;\n      await updateComment(state.commentId, {\n        content: state.updateComment\n      });\n      loadNewestComments(state.book.id);\n    };\n    return {\n      ...toRefs(state),\n      author_head,\n      no_comment,\n      bookContent,\n      bookDetail,\n      chapterList,\n      goToAnchor,\n      userComment,\n      deleteUserComment,\n      man,\n      updateUserComment,\n      goUpdateComment\n    };\n  },\n  mounted() {\n    $(\".icon_show\").click(function () {\n      $(this).hide();\n      $(\".icon_hide\").show();\n      $(\".intro_txt\").innerHeight(\"auto\");\n    });\n    $(\".icon_hide\").click(function () {\n      $(this).hide();\n      $(\".icon_show\").show();\n      $(\".intro_txt\").innerHeight(\"\");\n    });\n    $(\"#AuthorOtherNovel li\").unbind(\"mouseover\");\n    $(\"#txtComment\").on(\"input propertychange\", function () {\n      var count = $(this).val().length;\n      $(\"#emCommentNum\").html(count + \"/1000\");\n      if (count > 1000) {\n        $(\"#txtComment\").val($(\"#txtComment\").val().substring(0, 1000));\n      }\n    });\n  }\n};","map":{"version":3,"mappings":"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","names":["man","reactive","toRefs","onMounted","onUpdated","ElMessage","useRouter","useRoute","getBookById","addVisitCount","getLastChapterAbout","listRecBooks","listNewestComments","comment","deleteComment","updateComment","getUid","Header","Footer","author_head","no_comment","goToAnchor","name","components","setup","route","router","state","uid","book","books","chapterAbout","commentContent","newestComments","imgBaseUrl","process","env","VUE_APP_BASE_IMG_URL","dialogUpdateCommentFormVisible","commentId","bookId","params","id","loadBook","loadRecBooks","loadLastChapterAbout","loadNewestComments","console","log","i","length","document","getElementById","setAttribute","data","addBookVisit","bookContent","chapterId","push","path","bookDetail","chapterList","userComment","error","updateUserComment","deleteUserComment","goUpdateComment","content","mounted","$","click","hide","show","innerHeight","unbind","on","count","val","html","substring"],"sourceRoot":"","sources":["D:\\desktop\\小说精品屋\\novel-front-web-master\\novel-front-web-master\\src\\views\\Book.vue"],"sourcesContent":["<template>\n  <Header />\n  <div class=\"main box_center cf mb50\">\n    <div class=\"channelWrap channelBookInfo cf\">\n      <div class=\"bookCover cf\">\n        <a class=\"book_cover\">\n          <img id=\"bookCover\" class=\"cover\" :src=\"`${imgBaseUrl}` + `${book.picUrl}`\" :alt=\"book.bookName\" /></a>\n        <div class=\"book_info\">\n          <div class=\"tit\">\n            <h1>{{ book.bookName }}</h1>\n            <!--<i class=\"vip_b\">VIP</i>--><a class=\"author\">{{\n              book.authorName\n            }}</a>\n          </div>\n          <ul class=\"list\">\n            <li>\n              <span class=\"item\">类别：<em>{{ book.categoryName }}</em></span>\n              <span class=\"item\">状态：<em>{{\n                book.bookStatus == 0 ? \"连载中\" : \"已完结\"\n              }}</em></span>\n              <span class=\"item\">总点击：<em id=\"cTotal\">{{ book.visitCount }}</em></span>\n              <span class=\"item\">总字数：<em>{{ book.wordCount }}</em></span>\n            </li>\n          </ul>\n          <div class=\"intro_txt\">\n            <p style=\"white-space:break-spaces\" v-html=\"book.bookDesc\"></p>\n            <a class=\"icon_hide\" href=\"javascript:void(0)\" onclick=\"\"><i></i>收起</a>\n            <a class=\"icon_show\" href=\"javascript:void(0)\" onclick=\"\"><i></i>展开</a>\n          </div>\n          <div class=\"btns\" id=\"optBtn\">\n            <a href=\"javascript:void(0)\" @click=\"bookContent(book.id, book.firstChapterId)\" class=\"btn_ora\">点击阅读</a>\n            <!--\n            <span id=\"cFavs\"\n              ><a\n                href=\"javascript:void(0);\"\n                class=\"btn_ora_white btn_addsj\"\n                onclick=\"javascript:BookDetail.AddFavorites(37,0,0);\"\n                >加入书架</a\n              >\n            </span>-->\n          </div>\n        </div>\n      </div>\n    </div>\n\n    <div class=\"channelBookContent cf\">\n      <!--left start-->\n      <div class=\"wrap_left fl\">\n        <div class=\"wrap_bg\">\n          <!--章节目录 start-->\n          <div class=\"pad20_nobt\">\n            <div class=\"bookChapter\">\n              <div class=\"book_tit\">\n                <div class=\"fl\">\n                  <h3>最新章节</h3>\n                  <span id=\"bookIndexCount\">({{ chapterAbout.chapterTotal }}章)</span>\n                </div>\n                <a class=\"fr\" @click=\"chapterList(book.id)\" href=\"javascript:void(0)\">全部目录</a>\n              </div>\n              <ul class=\"list cf\">\n                <li>\n                  <span class=\"fl font16\">\n                    <a @click=\"\n                      bookContent(\n                        chapterAbout.chapterInfo.bookId,\n                        chapterAbout.chapterInfo.id\n                      )\n                      \" href=\"javascript:void(0)\" v-if=\"chapterAbout.chapterInfo\">{{\n    chapterAbout.chapterInfo.chapterName }}】</a></span>\n                  <span class=\"black9 fr\" v-if=\"chapterAbout.chapterInfo\">更新时间：{{\n                    chapterAbout.chapterInfo.chapterUpdateTime\n                  }}</span>\n                </li>\n                <li class=\"zj_yl\" id=\"lastBookContent\">\n                  <!--go-->\n                  　　<span v-html=\"`${chapterAbout.contentSummary}` + '...'\"></span>\n                </li>\n                <!--此处是该章节预览，截取最前面的42个字-->\n              </ul>\n            </div>\n          </div>\n          <!--章节目录 end-->\n\n          <!--作品评论区 start-->\n          <div class=\"pad20\">\n            <div class=\"bookComment\">\n              <div class=\"book_tit\">\n                <div class=\"fl\">\n                  <h3>作品评论区</h3>\n                  <span id=\"bookCommentTotal\">({{ newestComments.commentTotal }}条)</span>\n                </div>\n                <a class=\"fr\" @click=\"goToAnchor('txtComment')\" href=\"javascript:void(0)\">发表评论</a>\n              </div>\n              <div v-if=\"newestComments.commentTotal == 0\" class=\"no_comment\" id=\"noCommentPanel\">\n                <img :src=\"no_comment\" alt=\"\" />\n                <span class=\"block\">暂无评论</span>\n              </div>\n              <div v-if=\"newestComments.commentTotal > 0\" class=\"commentBar\" id=\"commentPanel\">\n                <div class=\"comment_list cf\" v-for=\"(item, index) in newestComments.comments\" :key=\"index\">\n                  <div class=\"user_heads fl\" vals=\"389\">\n                    <img :src=\"item.commentUserPhoto\n                        ? imgBaseUrl + item.commentUserPhoto\n                        : man\n                      \" class=\"user_head\" alt=\"\" /><span class=\"user_level1\" style=\"display: none\">见习</span>\n                  </div>\n                  <ul class=\"pl_bar fr\">\n                    <li class=\"name\">{{ item.commentUser }}</li>\n                    <li class=\"dec\" v-html=\"item.commentContent\"></li>\n                    <li class=\"other cf\">\n                      <span class=\"time fl\">{{ item.commentTime }}</span><span class=\"fr\"\n                        v-if=\"item.commentUserId == uid\"><a href=\"javascript:void(0);\" @click=\"\n                          updateUserComment(item.id, item.commentContent)\n                          \" class=\"zan\">修改</a>\n                        |\n                        <a href=\"javascript:void(0);\" @click=\"deleteUserComment(item.id)\" class=\"zan\">删除</a></span>\n                    </li>\n                  </ul>\n                </div>\n              </div>\n              <el-dialog v-model=\"dialogUpdateCommentFormVisible\" title=\"评论修改\">\n                <el-form>\n                  <el-form-item label=\"评论内容\">\n                    <el-input type=\"textarea\" v-model=\"updateComment\" />\n                  </el-form-item>\n                </el-form>\n                <template #footer>\n                  <span class=\"dialog-footer\">\n                    <el-button @click=\"dialogUpdateCommentFormVisible = false\">取消</el-button>\n                    <el-button type=\"primary\" @click=\"goUpdateComment()\">确定</el-button>\n                  </span>\n                </template>\n              </el-dialog>\n\n              <!--无评论时此处隐藏-->\n              <div class=\"more_bar\" id=\"moreCommentPanel\" style=\"display: none\">\n                <a href=\"/book/comment-1431636283466297344.html\">查看全部评论&gt;</a>\n              </div>\n\n              <div class=\"reply_bar\" id=\"reply_bar\">\n                <div class=\"tit\">\n                  <span class=\"fl font16\">发表评论</span>\n\n                  <span class=\"fr black9\" style=\"display: none\">请先 <a class=\"orange\" href=\"/user/login.html\">登录</a><em\n                      class=\"ml10 mr10\">|</em><a class=\"orange\" href=\"/user/register.html\">注册</a></span>\n                </div>\n\n                <textarea v-model=\"commentContent\" name=\"txtComment\" rows=\"2\" cols=\"20\" id=\"txtComment\"\n                  class=\"replay_text\" placeholder=\"我来说两句...\"></textarea>\n                <div class=\"reply_btn\">\n                  <span class=\"fl black9\"><em class=\"ml5\" id=\"emCommentNum\">0/1000</em> 字</span>\n                  <span class=\"fr\"><a class=\"btn_ora\" href=\"javascript:void(0);\" @click=\"userComment\">发表</a></span>\n                </div>\n              </div>\n            </div>\n          </div>\n          <!--作品评论区 end-->\n        </div>\n      </div>\n      <!--left end-->\n\n      <!--right start-->\n      <div class=\"wrap_right fr\">\n        <!--作者专栏s-->\n        <div class=\"wrap_inner author_info mb20\">\n          <div class=\"author_head cf\">\n            <a href=\"javascript:void(0);\" class=\"head\"><img :src=\"author_head\" alt=\"作者头像\" id=\"authorLogoImg\" /></a>\n            <div class=\"msg\">\n              <span class=\"icon_qyzz\">签约作家</span>\n              <h4>\n                <a href=\"javascript:searchByK('冷漠的天蝎')\">{{\n                  book.authorName\n                }}</a>\n              </h4>\n            </div>\n          </div>\n          <div class=\"author_intro cf\">\n            <h4>作者有话说</h4>\n            <div class=\"intro_txt\" id=\"authorNote\">\n              亲亲们，你们的支持是我最大的动力！求点击、求推荐、求书评哦！\n            </div>\n          </div>\n        </div>\n\n        <div id=\"RelateBookOther\" class=\"wrap_inner wrap_right_cont mb20\">\n          <div class=\"title cf\">\n            <h3 class=\"on\">同类推荐</h3>\n          </div>\n          <div class=\"tj_bar\">\n            <ul id=\"recBookList\">\n              <li v-for=\"(item, index) in books\" :key=\"index\">\n                <div class=\"book_intro\">\n                  <div class=\"cover\">\n                    <a href=\"javascript:void(0)\" @click=\"bookDetail(item.id)\"><img :id=\"'bookCover' + `${index}`\"\n                        :src=\"`${imgBaseUrl}` + `${item.picUrl}`\" :alt=\"item.bookName\" /></a>\n                  </div>\n                  <div class=\"dec\">\n                    <a href=\"javascript:void(0)\" @click=\"bookDetail(item.id)\">{{\n                      item.bookName\n                    }}</a>\n                    <a class=\"txt\" href=\"javascript:void(0)\" @click=\"bookDetail(item.id)\" v-html=\"item.bookDesc\"></a>\n                  </div>\n                </div>\n              </li>\n            </ul>\n          </div>\n        </div>\n      </div>\n      <!--right end-->\n    </div>\n  </div>\n\n  <Footer />\n</template>\n\n<script>\nimport \"@/assets/styles/book.css\";\nimport man from \"@/assets/images/man.png\";\nimport { reactive, toRefs, onMounted, onUpdated } from \"vue\";\nimport { ElMessage } from \"element-plus\";\nimport { useRouter, useRoute } from \"vue-router\";\nimport {\n  getBookById,\n  addVisitCount,\n  getLastChapterAbout,\n  listRecBooks,\n  listNewestComments,\n} from \"@/api/book\";\nimport { comment, deleteComment, updateComment } from \"@/api/user\";\nimport { getUid } from \"@/utils/auth\";\nimport Header from \"@/components/common/Header\";\nimport Footer from \"@/components/common/Footer\";\nimport author_head from \"@/assets/images/author_head.png\";\nimport no_comment from \"@/assets/images/no_comment.png\";\nimport { goToAnchor } from \"@/utils\";\nexport default {\n  name: \"book\",\n  components: {\n    Header,\n    Footer,\n  },\n  setup() {\n    const route = useRoute();\n    const router = useRouter();\n\n    const state = reactive({\n      uid: getUid(),\n      book: {},\n      books: [],\n      chapterAbout: {},\n      commentContent: \"\",\n      newestComments: {},\n      imgBaseUrl: process.env.VUE_APP_BASE_IMG_URL,\n      dialogUpdateCommentFormVisible: false,\n      commentId: \"\",\n      updateComment: \"\",\n    });\n    onMounted(() => {\n      const bookId = route.params.id;\n      loadBook(bookId);\n      loadRecBooks(bookId);\n      loadLastChapterAbout(bookId);\n      loadNewestComments(bookId);\n    });\n\n    onUpdated(() => {\n      console.log(\"onUpdated==========================\");\n      for (let i = 0; i < state.books.length; i++) {\n        document\n          .getElementById(\"bookCover\" + i)\n          .setAttribute(\"onerror\", \"this.src='default.gif';this.onerror=null\");\n      }\n    });\n\n    const loadBook = async (bookId) => {\n      const { data } = await getBookById(bookId);\n      state.book = data;\n      document\n        .getElementById(\"bookCover\")\n        .setAttribute(\"onerror\", \"this.src='default.gif';this.onerror=null\");\n      addBookVisit(bookId);\n    };\n\n    const loadRecBooks = async (bookId) => {\n      const { data } = await listRecBooks({ bookId: bookId });\n      state.books = data;\n    };\n\n    const loadLastChapterAbout = async (bookId) => {\n      const { data } = await getLastChapterAbout({ bookId: bookId });\n      state.chapterAbout = data;\n    };\n\n    const bookContent = (bookId, chapterId) => {\n      router.push({ path: `/book/${bookId}/${chapterId}` });\n    };\n\n    const bookDetail = (bookId) => {\n      router.push({ path: `/book/${bookId}` });\n      loadBook(bookId);\n      loadRecBooks(bookId);\n      loadLastChapterAbout(bookId);\n      loadNewestComments(bookId);\n    };\n\n    const chapterList = (bookId) => {\n      router.push({ path: `/chapter_list/${bookId}` });\n    };\n\n    const addBookVisit = async (bookId) => {\n      addVisitCount({ bookId: bookId });\n    };\n\n    const loadNewestComments = async (bookId) => {\n      const { data } = await listNewestComments({ bookId: bookId });\n      state.newestComments = data;\n    };\n\n    const userComment = async () => {\n      if (!state.commentContent) {\n        ElMessage.error(\"用户评论不能为空！\");\n        return;\n      }\n      if (state.commentContent.length < 10) {\n        ElMessage.error(\"评论不能少于 10 个字符！\");\n        return;\n      }\n      if (state.commentContent.length > 512) {\n        ElMessage.error(\"评论不能多于 512 个字符！\");\n        return;\n      }\n      await comment({\n        bookId: state.book.id,\n        commentContent: state.commentContent,\n      });\n      state.commentContent = \"\";\n      loadNewestComments(state.book.id);\n    };\n\n    const updateUserComment = async (id, comment) => {\n      state.dialogUpdateCommentFormVisible = true;\n      state.updateComment = comment;\n      state.commentId = id;\n    };\n\n    const deleteUserComment = async (id) => {\n      await deleteComment(id);\n      loadNewestComments(state.book.id);\n    };\n\n    const goUpdateComment = async (id) => {\n      state.dialogUpdateCommentFormVisible = false;\n      await updateComment(state.commentId, { content: state.updateComment });\n      loadNewestComments(state.book.id);\n    };\n\n    return {\n      ...toRefs(state),\n      author_head,\n      no_comment,\n      bookContent,\n      bookDetail,\n      chapterList,\n      goToAnchor,\n      userComment,\n      deleteUserComment,\n      man,\n      updateUserComment,\n      goUpdateComment,\n    };\n  },\n  mounted() {\n    $(\".icon_show\").click(function () {\n      $(this).hide();\n      $(\".icon_hide\").show();\n      $(\".intro_txt\").innerHeight(\"auto\");\n    });\n    $(\".icon_hide\").click(function () {\n      $(this).hide();\n      $(\".icon_show\").show();\n      $(\".intro_txt\").innerHeight(\"\");\n    });\n\n    $(\"#AuthorOtherNovel li\").unbind(\"mouseover\");\n\n    $(\"#txtComment\").on(\"input propertychange\", function () {\n      var count = $(this).val().length;\n      $(\"#emCommentNum\").html(count + \"/1000\");\n      if (count > 1000) {\n        $(\"#txtComment\").val($(\"#txtComment\").val().substring(0, 1000));\n      }\n    });\n  },\n};\n</script>\n\n<style>\n.el-button:not(.is-text) {\n  border: #f80;\n  border-color: #f80;\n}\n\n.el-button--primary {\n  --el-button-hover-bg-color: #f80;\n}\n\n.el-button--primary {\n  --el-button-bg-color: #f70;\n}\n\n.el-button {\n  --el-button-hover-text-color: #fafafa;\n}\n\n.el-button {\n  --el-button-hover-bg-color: #ff880061;\n}\n</style>\n"]},"metadata":{},"sourceType":"module"}